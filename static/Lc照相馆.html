<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高中时光记忆馆 - 2022-2025</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #6d5dca;
            --secondary-color: #a38cf7;
            --accent-color: #ff7aa8;
            --dark-color: #2a2a3c;
            --light-color: #f5f5f7;
            --card-bg: rgba(255, 255, 255, 0.85);
            --shadow-sm: 0 4px 6px rgba(0, 0, 0, 0.07);
            --shadow-md: 0 6px 12px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 15px 25px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* 导航栏样式 */
        header {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 20px;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo h1 {
            font-size: 1.8rem;
            color: var(--primary-color);
            font-weight: 700;
        }

        .logo-icon {
            font-size: 2rem;
            color: var(--accent-color);
        }

        nav ul {
            display: flex;
            list-style: none;
            gap: 25px;
        }

        nav a {
            text-decoration: none;
            color: var(--dark-color);
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 50px;
            transition: var(--transition);
        }

        nav a:hover, nav a.active {
            background: var(--primary-color);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        /* 搜索区域 */
        .search-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        .search-box {
            flex: 1;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 15px 20px 15px 50px;
            border: none;
            border-radius: 50px;
            background: var(--card-bg);
            box-shadow: var(--shadow-md);
            font-size: 1rem;
            transition: var(--transition);
        }

        .search-box input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(109, 93, 202, 0.3);
        }

        .search-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-color);
        }

        .upload-btn {
            padding: 15px 25px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow-md);
            transition: var(--transition);
        }

        .upload-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* 分类过滤器 */
        .categories {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .category {
            padding: 10px 20px;
            background: var(--card-bg);
            border-radius: 50px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }

        .category:hover, .category.active {
            background: var(--primary-color);
            color: white;
            box-shadow: var(--shadow-md);
        }

        /* 时间线样式 */
        .timeline {
            position: relative;
            margin: 40px 0;
            padding-left: 30px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: var(--primary-color);
            border-radius: 2px;
        }

        .timeline-year {
            position: relative;
            margin-bottom: 40px;
        }

        .timeline-year::before {
            content: '';
            position: absolute;
            left: -38px;
            top: 0;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent-color);
            border: 4px solid var(--primary-color);
        }

        .year-label {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .year-label::after {
            content: '';
            flex: 1;
            height: 2px;
            background: linear-gradient(to right, var(--primary-color), transparent);
            margin-left: 10px;
        }

        /* 照片网格 */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .photo-card {
            background: var(--card-bg);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            transition: var(--transition);
            cursor: pointer;
            position: relative;
        }

        .photo-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .photo-img {
            height: 220px;
            overflow: hidden;
            background: linear-gradient(135deg, #e0e0e0 0%, #c3cfe2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            color: #999;
        }

        .photo-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-info {
            padding: 20px;
        }

        .photo-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--dark-color);
        }

        .photo-date {
            color: #777;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* 无照片时的空卡片样式 - 只显示基础卡片框架 */
        .empty-card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            padding: 30px 20px;
            text-align: center;
            color: #999;
            transition: var(--transition);
        }

        .empty-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .empty-card i {
            font-size: 2rem;
            margin-bottom: 15px;
            color: #ccc;
        }

        .empty-card p {
            font-weight: 500;
        }

        /* 加载指示器 */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 上传模态框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            max-width: 600px;
            width: 100%;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            padding: 30px;
        }

        .modal-header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #777;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .submit-btn:hover {
            background: var(--secondary-color);
        }

        /* 详情模态框 */
        .detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(5px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .detail-modal-content {
            background: white;
            max-width: 900px;
            width: 100%;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }

        .detail-modal-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
        }

        .detail-modal-body {
            display: flex;
            height: 70vh;
        }

        .detail-modal-image {
            flex: 7;
            overflow: hidden;
        }

        .detail-modal-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .detail-modal-info {
            flex: 3;
            padding: 25px;
            overflow-y: auto;
        }

        /* 页脚 */
        footer {
            text-align: center;
            padding: 30px;
            color: #777;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            margin-top: 50px;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 20px;
            }
            
            nav ul {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .search-bar {
                flex-direction: column;
            }
            
            .timeline {
                padding-left: 20px;
            }
            
            .timeline::before {
                left: -10px;
            }
            
            .timeline-year::before {
                left: -28px;
            }
            
            .detail-modal-body {
                flex-direction: column;
                height: auto;
            }
            
            .detail-modal-image {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-camera-retro logo-icon"></i>
                <h1>高中时光记忆馆</h1>
            </div>
            <nav>
                <ul>
                    <li><a href="#" class="active">所有照片</a></li>
                    <li><a href="#">班级活动</a></li>
                    <li><a href="#">毕业照</a></li>
                    <li><a href="#">运动会</a></li>
                    <li><a href="#">课外活动</a></li>
                </ul>
            </nav>
        </header>

        <div class="search-bar">
            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="searchInput" placeholder="搜索照片、人物或事件...">
            </div>
            <button class="upload-btn" id="openUploadModal">
                <i class="fas fa-cloud-upload-alt"></i>
                上传照片
            </button>
        </div>

        <div class="categories">
            <div class="category active" data-category="全部">全部</div>
            <div class="category" data-category="高一">高一</div>
            <div class="category" data-category="高二">高二</div>
            <div class="category" data-category="高三">高三</div>
            <div class="category" data-category="班级合影">班级合影</div>
            <div class="category" data-category="校园风景">校园风景</div>
            <div class="category" data-category="活动记录">活动记录</div>
        </div>

        <!-- 时间线容器 -->
        <div class="timeline" id="timelineContainer">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>

        <footer>
            <p>© 2023 高中时光记忆馆 - 珍藏2022-2025每一刻美好回忆</p>
        </footer>
    </div>

    <!-- 上传照片模态框 -->
    <div class="modal" id="uploadModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>上传新照片</h2>
                <button class="close-btn" id="closeUploadModal">&times;</button>
            </div>
            <form id="uploadForm">
                <div class="form-group">
                    <label for="photoTitle">照片标题</label>
                    <input type="text" id="photoTitle" required>
                </div>
                <div class="form-group">
                    <label for="photoDescription">照片描述</label>
                    <textarea id="photoDescription"></textarea>
                </div>
                <div class="form-group">
                    <label for="photoDate">拍摄日期</label>
                    <input type="date" id="photoDate" required>
                </div>
                <div class="form-group">
                    <label for="photoCategory">分类</label>
                    <select id="photoCategory" required>
                        <option value="">请选择分类</option>
                        <option value="class">班级活动</option>
                        <option value="graduation">毕业照</option>
                        <option value="sports">运动会</option>
                        <option value="activity">课外活动</option>
                        <option value="campus">校园风景</option>
                        <option value="other">其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="photoFile">选择照片</label>
                    <input type="file" id="photoFile" accept="image/*" required>
                </div>
                <button type="submit" class="submit-btn">上传照片</button>
            </form>
        </div>
    </div>

    <!-- 照片详情模态框 -->
    <div class="detail-modal" id="detailModal">
        <div class="detail-modal-content">
            <div class="detail-modal-header">
                <h2 id="modalTitle">照片标题</h2>
                <button class="close-btn" id="closeDetailModal">&times;</button>
            </div>
            <div class="detail-modal-body">
                <div class="detail-modal-image">
                    <img src="" alt="Modal Image" id="modalImage">
                </div>
                <div class="detail-modal-info">
                    <h3>照片信息</h3>
                    <p id="modalDate">日期：</p>
                    <p id="modalDescription">照片描述</p>
                    
                    <h3>标签</h3>
                    <div class="categories" id="modalTags">
                        <!-- 标签将通过JS动态添加 -->
                    </div>
                    
                    <h3>操作</h3>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="submit-btn" style="flex: 1;" id="downloadBtn">下载原图</button>
                        <button class="submit-btn" style="flex: 1; background: #dc3545;" id="deleteBtn">删除照片</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 配置参数
        const API_BASE_URL = 'http://localhost:5000/api';
        const B_FILE_YEARS = ['2025', '2024', '2023'];
        
        // 全局变量
        let isBackendConnected = false;
        let allPhotos = [];
        let currentPhotoId = null;

        // 页面初始化
        document.addEventListener('DOMContentLoaded', async function() {
            // 检测后端连接状态
            await checkBackendConnection();
            
            // 初始化功能模块
            initModals();
            initCategoryFilter();
            
            // 只有后端连接成功才初始化搜索功能
            if (isBackendConnected) {
                initSearch();
            }
            
            // 根据连接状态加载对应样式的照片
            loadPhotosByConnectionStatus();
        });

        /**
         * 检测后端连接状态
         */
        async function checkBackendConnection() {
            try {
                const response = await fetch(`${API_BASE_URL}/photos`, { 
                    method: 'GET',
                    timeout: 5000 // 5秒超时
                });
                
                isBackendConnected = response.ok;
                
                if (isBackendConnected) {
                    const data = await response.json();
                    allPhotos = data.photos || [];
                }
            } catch (error) {
                isBackendConnected = false;
                console.log('后端连接失败，切换到B文件模式:', error);
            }
        }

        /**
         * 初始化所有模态框
         */
        function initModals() {
            // 上传模态框相关元素
            const uploadModal = document.getElementById('uploadModal');
            const openUploadBtn = document.getElementById('openUploadModal');
            const closeUploadBtn = document.getElementById('closeUploadModal');
            const uploadForm = document.getElementById('uploadForm');
            
            // 详情模态框相关元素
            const detailModal = document.getElementById('detailModal');
            const closeDetailBtn = document.getElementById('closeDetailModal');
            const downloadBtn = document.getElementById('downloadBtn');
            const deleteBtn = document.getElementById('deleteBtn');

            // 打开上传模态框
            openUploadBtn.addEventListener('click', function() {
                uploadModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            });
            
            // 关闭上传模态框
            closeUploadBtn.addEventListener('click', function() {
                uploadModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            });
            
            // 点击上传模态框外部关闭
            uploadModal.addEventListener('click', function(e) {
                if (e.target === uploadModal) {
                    uploadModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            });
            
            // 关闭详情模态框
            closeDetailBtn.addEventListener('click', function() {
                detailModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            });
            
            // 点击详情模态框外部关闭
            detailModal.addEventListener('click', function(e) {
                if (e.target === detailModal) {
                    detailModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            });
            
            // 上传表单提交处理
            uploadForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (isBackendConnected) {
                    // 后端连接成功 - 执行实际上传
                    await handlePhotoUpload();
                } else {
                    // 后端连接失败 - 模拟上传
                    alert('照片上传功能需要后端支持。在实际应用中，这里会将照片上传到服务器。');
                    uploadModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            });
            
            // 下载按钮事件
            downloadBtn.addEventListener('click', function() {
                if (!isBackendConnected || !currentPhotoId) return;
                
                const photo = allPhotos.find(p => p.id === currentPhotoId);
                if (photo && photo.filename) {
                    const link = document.createElement('a');
                    link.href = `${API_BASE_URL}/uploads/${photo.filename}`;
                    link.download = photo.title;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            });
            
            // 删除按钮事件
            deleteBtn.addEventListener('click', async function() {
                if (!isBackendConnected || !currentPhotoId) return;
                
                if (confirm('确定要删除这张照片吗？此操作不可恢复。')) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/photos/${currentPhotoId}`, {
                            method: 'DELETE'
                        });
                        
                        if (!response.ok) {
                            throw new Error('删除失败');
                        }
                        
                        alert('照片删除成功');
                        detailModal.style.display = 'none';
                        loadPhotosByConnectionStatus();
                    } catch (error) {
                        alert('删除失败: ' + error.message);
                    }
                }
            });
        }

        /**
         * 初始化分类筛选功能
         */
        function initCategoryFilter() {
            const categories = document.querySelectorAll('.category');
            
            categories.forEach(category => {
                category.addEventListener('click', function() {
                    // 更新活跃状态
                    categories.forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    
                    const filterValue = this.textContent;
                    
                    if (isBackendConnected) {
                        // 后端连接成功 - 执行实际筛选
                        filterPhotos(filterValue);
                    } else {
                        // 后端连接失败 - 模拟筛选
                        alert(`在实际应用中，这里会根据"${filterValue}"筛选条件从后端获取数据`);
                    }
                });
            });
        }

        /**
         * 初始化搜索功能（仅在后端连接成功时）
         */
        function initSearch() {
            const searchInput = document.getElementById('searchInput');
            
            searchInput.addEventListener('input', debounce(function() {
                const searchTerm = searchInput.value.trim().toLowerCase();
                
                if (searchTerm) {
                    // 前端筛选
                    const filteredPhotos = allPhotos.filter(photo => {
                        const titleMatch = photo.title.toLowerCase().includes(searchTerm);
                        const descMatch = photo.description && 
                                          photo.description.toLowerCase().includes(searchTerm);
                        return titleMatch || descMatch;
                    });
                    
                    renderPhotosByYear(filteredPhotos);
                } else {
                    // 搜索为空时显示所有照片
                    loadPhotosByConnectionStatus();
                }
            }, 300));
        }

        /**
         * 根据后端连接状态加载照片
         */
        function loadPhotosByConnectionStatus() {
            const timelineContainer = document.getElementById('timelineContainer');
            timelineContainer.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            if (isBackendConnected) {
                // 后端连接成功 - 使用A文件样式
                renderPhotosByYear(allPhotos);
            } else {
                // 后端连接失败 - 使用B文件样式
                renderBFileTimeline();
            }
        }

        /**
         * 按年份渲染照片（A文件样式）
         */
        function renderPhotosByYear(photos) {
            const timelineContainer = document.getElementById('timelineContainer');
            timelineContainer.innerHTML = '';
            
            // 按年份分组
            const photosByYear = {};
            photos.forEach(photo => {
                const year = new Date(photo.date_taken).getFullYear().toString();
                if (!photosByYear[year]) {
                    photosByYear[year] = [];
                }
                photosByYear[year].push(photo);
            });
            
            // 按年份倒序排列
            const sortedYears = Object.keys(photosByYear).sort((a, b) => b - a);
            
            // 生成时间线内容
            sortedYears.forEach(year => {
                const yearSection = document.createElement('div');
                yearSection.className = 'timeline-year';
                
                // 确定年级
                const grade = getGradeByYear(year);
                
                yearSection.innerHTML = `
                    <h2 class="year-label">${year}年 · ${grade}</h2>
                    <div class="photo-grid" id="photos-${year}"></div>
                `;
                
                timelineContainer.appendChild(yearSection);
                
                // 生成照片卡片
                const photoGrid = document.getElementById(`photos-${year}`);
                
                if (photosByYear[year].length > 0) {
                    // 有照片时 - 显示带照片容器的卡片
                    photosByYear[year].forEach(photo => {
                        const photoCard = createPhotoCard(photo);
                        photoGrid.appendChild(photoCard);
                    });
                } else {
                    // 无照片时 - 只显示基础卡片框架，不显示照片容器
                    const emptyCard = createEmptyCard(`该年份暂无照片`);
                    photoGrid.appendChild(emptyCard);
                }
            });
            
            // 如果没有任何照片数据
            if (sortedYears.length === 0) {
                const emptySection = document.createElement('div');
                emptySection.className = 'timeline-year';
                emptySection.innerHTML = `
                    <div class="photo-grid">
                        ${createEmptyCard('暂无任何照片数据').outerHTML}
                    </div>
                `;
                timelineContainer.appendChild(emptySection);
            }
        }

        /**
         * 渲染B文件样式的时间线
         */
        function renderBFileTimeline() {
            const timelineContainer = document.getElementById('timelineContainer');
            timelineContainer.innerHTML = '';
            
            // B文件模拟数据
            const mockData = {
                "2025": [
                    { id: 1, title: "毕业典礼", date: "2025-06-10", category: "graduation" },
                    { id: 2, title: "高考前最后一天", date: "2025-06-05", category: "class" },
                    { id: 3, title: "毕业晚会", date: "2025-05-20", category: "activity" }
                ],
                "2024": [
                    { id: 4, title: "篮球比赛夺冠", date: "2024-11-08", category: "sports" },
                    { id: 5, title: "秋季运动会", date: "2024-09-15", category: "sports" },
                    { id: 6, title: "校园文化节", date: "2024-03-12", category: "activity" }
                ],
                "2023": [
                    { id: 7, title: "开学典礼", date: "2023-09-01", category: "class" },
                    { id: 8, title: "军训时光", date: "2023-08-20", category: "activity" },
                    { id: 9, title: "第一次班会", date: "2023-08-18", category: "class" }
                ]
            };
            
            // 生成固定学年的时间线
            B_FILE_YEARS.forEach(year => {
                const yearSection = document.createElement('div');
                yearSection.className = 'timeline-year';
                
                // 设置学年标题
                let yearLabel = '';
                if (year === '2025') yearLabel = '2024-2025学年 · 高三';
                if (year === '2024') yearLabel = '2023-2024学年 · 高二';
                if (year === '2023') yearLabel = '2022-2023学年 · 高一';
                
                yearSection.innerHTML = `
                    <h2 class="year-label">${yearLabel}</h2>
                    <div class="photo-grid" id="photos-${year}"></div>
                `;
                
                timelineContainer.appendChild(yearSection);
                
                // 生成照片卡片
                const photoGrid = document.getElementById(`photos-${year}`);
                
                // 检查是否有模拟数据
                if (mockData[year] && mockData[year].length > 0) {
                    // 有模拟数据时显示完整卡片
                    mockData[year].forEach(photo => {
                        const card = document.createElement('div');
                        card.className = 'photo-card';
                        
                        card.innerHTML = `
                            <div class="photo-img">
                                <i class="fas fa-image fa-3x"></i>
                            </div>
                            <div class="photo-info">
                                <h3 class="photo-title">${photo.title}</h3>
                                <div class="photo-date">
                                    <i class="far fa-calendar-alt"></i>
                                    <span>${photo.date}</span>
                                </div>
                            </div>
                        `;
                        
                        photoGrid.appendChild(card);
                    });
                } else {
                    // 无模拟数据时显示空卡片框架
                    const emptyCard = createEmptyCard(`该学年暂无照片`);
                    photoGrid.appendChild(emptyCard);
                }
            });
        }

        /**
         * 创建带照片的卡片（有照片时使用）
         */
        function createPhotoCard(photo) {
            const card = document.createElement('div');
            card.className = 'photo-card';
            
            // 格式化日期
            const date = new Date(photo.date_taken);
            const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
            
            // 照片内容
            let imgContent = '<div class="photo-img"><i class="fas fa-image fa-3x"></i></div>';
            if (photo.filename) {
                const imgUrl = photo.thumbnail 
                    ? `${API_BASE_URL}/uploads/thumbnails/${photo.thumbnail}`
                    : `${API_BASE_URL}/uploads/${photo.filename}`;
                imgContent = `<div class="photo-img"><img src="${imgUrl}" alt="${photo.title}" loading="lazy"></div>`;
            }
            
            card.innerHTML = `
                ${imgContent}
                <div class="photo-info">
                    <h3 class="photo-title">${photo.title}</h3>
                    <div class="photo-date">
                        <i class="far fa-calendar-alt"></i>
                        <span>${formattedDate}</span>
                    </div>
                </div>
            `;
            
            // 点击打开详情模态框
            card.addEventListener('click', () => openPhotoDetail(photo));
            
            return card;
        }

        /**
         * 创建空卡片（无照片时使用，只显示基础框架）
         */
        function createEmptyCard(message) {
            const card = document.createElement('div');
            card.className = 'empty-card';
            
            card.innerHTML = `
                <i class="far fa-images"></i>
                <p>${message}</p>
            `;
            
            return card;
        }

        /**
         * 打开照片详情模态框
         */
        function openPhotoDetail(photo) {
            if (!isBackendConnected) return;
            
            currentPhotoId = photo.id;
            
            const modalTitle = document.getElementById('modalTitle');
            const modalImage = document.getElementById('modalImage');
            const modalDate = document.getElementById('modalDate');
            const modalDescription = document.getElementById('modalDescription');
            const modalTags = document.getElementById('modalTags');
            
            // 设置模态框内容
            modalTitle.textContent = photo.title;
            
            // 设置图片
            const imageUrl = photo.filename 
                ? `${API_BASE_URL}/uploads/${photo.filename}`
                : '';
            modalImage.src = imageUrl;
            modalImage.alt = photo.title;
            
            // 设置日期
            const date = new Date(photo.date_taken);
            const fullDate = `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
            modalDate.textContent = `拍摄日期: ${fullDate}`;
            
            // 设置描述
            modalDescription.textContent = photo.description || '暂无描述';
            
            // 设置标签
            modalTags.innerHTML = '';
            const tag = document.createElement('div');
            tag.className = 'category';
            tag.textContent = getCategoryName(photo.category);
            modalTags.appendChild(tag);
            
            // 显示模态框
            document.getElementById('detailModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        /**
         * 筛选照片
         */
        async function filterPhotos(filterValue) {
            const timelineContainer = document.getElementById('timelineContainer');
            timelineContainer.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                let url = `${API_BASE_URL}/photos`;
                
                // 根据筛选值构建请求参数
                if (filterValue === '高一') {
                    url += '?year=2023';
                } else if (filterValue === '高二') {
                    url += '?year=2024';
                } else if (filterValue === '高三') {
                    url += '?year=2025';
                } else if (filterValue === '班级合影') {
                    url += '?category=class';
                } else if (filterValue === '校园风景') {
                    url += '?category=campus';
                } else if (filterValue === '活动记录') {
                    url += '?category=activity';
                }
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('筛选失败');
                }
                
                const data = await response.json();
                renderPhotosByYear(data.photos || []);
            } catch (error) {
                console.error('筛选照片失败:', error);
                alert('筛选照片失败: ' + error.message);
                loadPhotosByConnectionStatus();
            }
        }

        /**
         * 处理照片上传
         */
        async function handlePhotoUpload() {
            const title = document.getElementById('photoTitle').value;
            const description = document.getElementById('photoDescription').value;
            const date = document.getElementById('photoDate').value;
            const category = document.getElementById('photoCategory').value;
            const fileInput = document.getElementById('photoFile');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('请选择要上传的照片');
                return;
            }
            
            const file = fileInput.files[0];
            
            // 创建FormData
            const formData = new FormData();
            formData.append('photo', file);
            formData.append('title', title);
            formData.append('description', description);
            formData.append('date_taken', date);
            formData.append('category', category);
            
            try {
                const response = await fetch(`${API_BASE_URL}/photos`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || '上传失败');
                }
                
                alert('照片上传成功!');
                
                // 关闭模态框并重置表单
                document.getElementById('uploadModal').style.display = 'none';
                document.getElementById('uploadForm').reset();
                document.body.style.overflow = 'auto';
                
                // 重新加载照片
                loadPhotosByConnectionStatus();
            } catch (error) {
                alert('上传失败: ' + error.message);
            }
        }

        /**
         * 根据年份获取年级
         */
        function getGradeByYear(year) {
            const currentYear = new Date().getFullYear();
            if (year == currentYear) return '高三';
            if (year == currentYear - 1) return '高二';
            if (year == currentYear - 2) return '高一';
            return '';
        }

        /**
         * 获取分类名称
         */
        function getCategoryName(category) {
            const categoryMap = {
                'class': '班级活动',
                'graduation': '毕业照',
                'sports': '运动会',
                'activity': '课外活动',
                'campus': '校园风景',
                'other': '其他'
            };
            return categoryMap[category] || category;
        }

        /**
         * 防抖函数
         */
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>
